# Data Standards
This directory contains data standards, program configurations and constraints which are not expected to
change frequently.


# FICLOs
MorphFITS operates on data using the categorization structure of FICLOs, which
is an acronym for the Field, Image version, Catalog version, fiLter, and Object ID
of a galaxy or cluster to be fitted.

|Letter|Variable|Description|Example|
|:---|:---|:---|:---|
|`F`|`field`|Center of field at which JWST instrument is pointed.|`abell2744clu`|
|`I`|`image_version`|Program used to process JWST data.|`grizli-v7.2`|
|`C`|`catalog_version`|Source of photometric catalog.|`dja-v7.2`|
|`L`|`filter`|Instrument filter(s) used.|`f200w-clear`|
|`O`|`object`|Integer ID of galaxy or cluster in catalog.|`4215`|
|`P`|`pixscale`|Pixel scale, in arcseconds per pixel, as text.|`40mas`|
|`i`|`input_root`|Root input directory.|`morphfits_root/input`|
|`o`|`output_root`|Root output directory.|`morphfits_root/output`|
|`p`|`product_root`|Root products directory.|`morphfits_root/products`|
|`r`|`run_root`|Root directory for each run.|`morphfits_root/runs`|
|`D`|`date_time`|Datetime at start of run, in ISO-8601.|`20230625T145928`|
|`N`|`process_id`|ID of process in batch.|`002`|
|`z`||Auxiliary DJA processing version.|`drc` or `drz`|


# Files
MorphFITS operates in three distinct data stages - input, products, and output. 

1. Input files are downloaded directly from the [JWST Mosaics
index](https://s3.amazonaws.com/grizli-v2/JwstMosaics/v7/index.html) and the
J-HIVE data directory, stored under the input root. For more details on the
input PSF files, please refer to the [scripts directory](../scripts/README.md).
2. Product files are intermediate FICLO files generated by the program, stored
under the product root.
3. Output files are model, catalog, and image files generated by the program,
stored under the output root.
4. Each program run also has its own unique output files, stored under the run
root.

|Name|Stage|Location|
|:---|:---|:---|
|Input PSF|Input|`i/psfs/L_P_psf.fits`|
|Input Catalog|Input|`i/F/I/F-I-fix_phot_apcorr.fits`|
|Segmentation Map|Input|`i/F/I/F-I-ir_seg.fits`|
|Science Frame|Input|`i/F/I/L/F-I-L_drz_sci.fits`|
|Exposure Map|Input|`i/F/I/L/F-I-L_drz_exp.fits`|
|Weights Map|Input|`i/F/I/L/F-I-L_drz_wht.fits`|
|Stamp|Product|`p/F/I/C/L/O/F_I_C_L_O_stamp.fits`|
|Sigma Map|Product|`p/F/I/C/L/O/F_I_C_L_O_sigma.fits`|
|FICL PSF|Product|`p/F/I/C/L/F_I_C_L_psf.fits`|
|PSF|Product|`p/F/I/C/L/O/F_I_C_L_O_psf.fits`|
|Mask|Product|`p/F/I/C/L/O/F_I_C_L_O_mask.fits`|
|Feedfile|Product|`p/F/I/C/L/O/F_I_C_L_O.feedfile`|
|GALFIT Model|Output|`o/F/I/C/L/O/F_I_C_L_O_galfit.fits`|
|GALFIT Fit Log|Output|`o/F/I/C/L/O/F_I_C_L_O_galfit.log`|
|GALFIT Model Plot|Output|`o/F/I/C/L/O/F_I_C_L_O_galfit.png`|
|Histogram|Output|`o/histograms/D_N_histogram.png`|
|Merge Catalog|Output|`o/merge/D_N_catalog.csv`|
|Morphology Catalog|Output|`o/morphology/F_I_C_catalog.csv`|


The program organizes these files in the following filesystem structure.

<table>
<tr>
<th>
In Filesystem
</th>
<th>
In Program
</th>
</tr>

<tr>
<td>
<pre>
morphfits_root/
├── input/
│   ├── psfs/
│   │   └── L_P_psf.fits
│   └── F/
│       └── I/
│           ├── F-I-ir_seg.fits
│           ├── F-I-fix_phot_apcorr.fits
│           └── L/
│               ├── F-I-L_drz_exp.fits
│               ├── F-I-L_drz_sci.fits
│               └── F-I-L_drz_wht.fits
├── output/
│   ├── merge/
│   │   └── D_N_catalog.csv
│   ├── morphology/
│   │   └── F_I_C_catalog.csv
│   ├── histograms/
│   │   └── D_N_histogram.png
│   └── F/
│       └── I/
│           └── C/
│               └── L/
│                   └── O/
│                       ├── F_I_C_L_O_galfit.log
│                       ├── F_I_C_L_O_galfit.fits
│                       └── F_I_C_L_O_galfit.png
├── products/
│   └── F/
│       └── I/
│           └── C/
│               └── L/
│                   ├── F_I_C_L_psf.fits
│                   └── O/
│                       ├── F_I_C_L_O_mask.fits
│                       ├── F_I_C_L_O_psf.fits
│                       ├── F_I_C_L_O_sigma.fits
│                       ├── F_I_C_L_O_stamp.fits
│                       └── F_I_C_L_O.feedfile
└── runs/
    └── F.D.N/
        ├── catalog.csv
        ├── files.csv
        ├── histogram.png
        ├── morphfits.log
        └── settings.yaml
</pre>
</td>

<td>
<pre>
morphfits_root
input_root
input_psfs
input_psf
input_f
input_fi
input_catalog
input_segmap
input_fil
exposure
science
weights
output_root
output_merge_catalogs
merge_catalog
output_morphology_catalogs
morphology_catalog
output_histograms
histogram
output_f
output_fi
output_fic
output_ficl
output_ficlo
log_galfit
model_galfit
plot_galfit
product_root
product_f
product_fi
product_fic
product_ficl
ficl_psf
product_ficlo
mask
psf
sigma
stamp
feedfile
run_root
run
run_catalog
run_files
run_histogram
run_log
run_settings
</pre>
</td>
</tr>
</table>


# Catalog
MorphFITS generates three kinds of catalog files.

|Catalog|Location|Description|
|:---|:---|:---|
|Merge|`output/merge/`|Updated full catalog. The latest file in this directory is the most up to date catalog.|
|Morphology|`output/morphology/`|Per-FIC catalog. Each FIC has its own morphology catalog, which is updated upon each catalog stage run.|
|Run|`runs/{D}.{N}/`|Catalog for this run. Only contains fitting information from fitting the FICLs for this run.|

A row in a merge catalog contains the following information.

|Header|Type|Description|
|:---|:---|:---|
|`use`|`bool`|This model is usable for scientific analysis.|
|`field`|`str`|Field of image.|
|`image version`|`str`|Image processing version.|
|`catalog version`|`str`|Cataloging version.|
|`filter`|`str`|Filter wavelength.|
|`object`|`int`|Object ID in catalog.|
|`return code`|`int`|GALFIT return code.|
|`flags`|`int`|GALFIT flags bitmask.|
|`convergence`|`int`|Fitting parameter convergence bitmask.|
|`chi^2/nu`|`float`|Reduced chi squared of fit.|
|`center x`|`float`|X-position of model center.|
|`center x error`|`float`|Error on center x.|
|`center y`|`float`|Y-position of model center.|
|`center y error`|`float`|Error on center y.|
|`surface brightness`|`float`|Flux at surface of object.|
|`surface brightness error`|`float`|Error on surface brightness.|
|`effective radius`|`float`|Effective object radius.|
|`effective radius error`|`float`|Error on effective radius.|
|`sersic`|`float`|`n`, concentration parameter.|
|`sersic error`|`float`|Error on concentration parameter.|
|`axis ratio`|`float`|Ratio of model axes.|
|`axis ratio error`|`float`|Error on axis ratio.|
|`position angle`|`float`|Rotation angle of model.|
|`position angle error`|`float`|Error on position angle.|
|`surface brightness estimate`|`float`|Initial surface brightness estimate.|

A row in a morphology catalog contains the following information.

|Header|Type|Description|
|:---|:---|:---|
|`object`|`int`|Object ID in catalog.|
|`use ({L})`|`bool`|This model is usable for scientific analysis.|
|`chi^2/nu ({L})`|`float`|Reduced chi squared of object fit.|
|`surface brightness ({L})`|`float`|Flux at surface of object.|
|`surface brightness error ({L})`|`float`|Error on surface brightness.|
|`effective radius ({L})`|`float`|Effective object radius.|
|`effective radius error ({L})`|`float`|Error on effective radius.|
|`sersic ({L})`|`float`|`n`, concentration parameter.|
|`sersic error ({L})`|`float`|Error on sersic.|
|`axis ratio ({L})`|`float`|Ratio of model axes.|
|`axis ratio error ({L})`|`float`|Error on axis ratio.|

where there are `10*n_filter + 1` columns, 10 for each parameter per filter.

A breakdown of the `return code`, `flags`, and `convergence` follows. 

Note for a fit to be considered "usable", it must have a valid return code, a
valid GALFIT flag bitmask, and its fitted radius to error ratio must be greater
than 2.


## GALFIT Return Codes
These are known integer values returned by the GALFIT binary executable. For a
fit to be considered "usable", it must return with the value `0`.

|Code|Description|
|:---|:---|
|`0`|Fitting executed without termination.|
|`1`|Fitting failed.|
|`2`|Missing products.|
|`139`|Segmentation fault.|


## GALFIT Flags Bitmask
These are the flags raised by GALFIT during a fitting, found in the model file.
For a fit to be considered "usable", it must not have raised any of the failing
flags.

|Flag|Fails|Bit|Value|Description|
|:---|:---:|---:|---:|:---|
|`1`|:x:|0|1|Maximum number of iterations reached. Quit out early.|
|`2`|:x:|1|2|Suspected numerical convergence error in current solution.|
|`A-1`|:x:|2|4|No input data image found. Creating model only.|
|`A-2`|:x:|3|8|PSF image not found.  No convolution performed.|
|`A-3`||4|16|No CCD diffusion kernel found or applied.|
|`A-4`|:x:|5|32|No bad pixel mask image found.|
|`A-5`|:x:|6|64|No sigma image found.|
|`A-6`|:x:|7|128|No constraint file found.|
|`C-1`|:x:|8|256|Error parsing the constraint file.|
|`C-2`||9|512|Trying to constrain a parameter that is being held fixed.|
|`H-1`||10|1024|Exposure time header keyword is missing.  Default to 1 second.|
|`H-2`||11|2048|Exposure time is zero seconds.  Default to 1 second.|
|`H-3`||12|4096|`GAIN` header information is missing.|
|`H-4`||13|8192|`NCOMBINE` header information is missing.|
|`I-1`||14|16384|Convolution PSF exceeds the convolution box.|
|`I-2`||15|32768|Fitting box exceeds image boundary.|
|`I-3`||16|65536|Some pixels have infinite ADUs; set to 0.|
|`I-4`||17|131072|Sigma image has zero or negative pixels; set to 1e10.|
|`I-5`||18|262144|Pixel mask is not same size as data image.|

For example, a bitmask of 768 would mean the flags at bits 8 and 9 were raised,
which would mean the fit is unusable, since 8 is considered a failing flag.


## GALFIT Convergence Bitmask
These are the values added if a parameter has failed to converge.

|Parameter|Fails|Bit|Value|
|:---|:---|:---|:---|
|`effective radius`|:x:|0|1|
|`sersic`|:x:|1|2|
|`axis ratio`|:x:|2|4|

For example, a bitmask of 3 would mean the flags at bits 0 and 1 were raised,
which would mean the effective radius and sersic index failed to converge for
the object.